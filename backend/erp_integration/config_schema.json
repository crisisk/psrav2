{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://psra.sevensa.com/schemas/erp-integration-config.json",
  "title": "ERP Integration Configuration Schema",
  "description": "Configuration schema for ERP integration adapters, retry policies, and timeout settings",
  "type": "object",
  "required": ["adapter_type", "connection", "retry_policy"],
  "properties": {
    "adapter_type": {
      "type": "string",
      "enum": ["sap", "odoo", "dynamics", "oracle", "custom"],
      "description": "Type of ERP adapter to use"
    },
    "connection": {
      "type": "object",
      "description": "ERP connection parameters (adapter-specific)",
      "oneOf": [
        {
          "$ref": "#/definitions/sap_connection"
        },
        {
          "$ref": "#/definitions/odoo_connection"
        },
        {
          "$ref": "#/definitions/generic_connection"
        }
      ]
    },
    "retry_policy": {
      "$ref": "#/definitions/retry_policy"
    },
    "timeout_settings": {
      "$ref": "#/definitions/timeout_settings"
    },
    "monitoring": {
      "$ref": "#/definitions/monitoring_config"
    },
    "features": {
      "$ref": "#/definitions/feature_flags"
    }
  },
  "definitions": {
    "sap_connection": {
      "type": "object",
      "required": ["ashost", "sysnr", "client", "user", "passwd"],
      "properties": {
        "ashost": {
          "type": "string",
          "description": "SAP application server hostname",
          "examples": ["sap.example.com", "10.0.1.100"]
        },
        "sysnr": {
          "type": "string",
          "pattern": "^[0-9]{2}$",
          "description": "SAP system number (00-99)",
          "examples": ["00", "01", "10"]
        },
        "client": {
          "type": "string",
          "pattern": "^[0-9]{3,4}$",
          "description": "SAP client number",
          "examples": ["800", "100", "300"]
        },
        "user": {
          "type": "string",
          "description": "SAP username",
          "minLength": 1,
          "maxLength": 64
        },
        "passwd": {
          "type": "string",
          "description": "SAP password or credential reference",
          "minLength": 1
        },
        "lang": {
          "type": "string",
          "default": "EN",
          "pattern": "^[A-Z]{2}$",
          "description": "SAP language code",
          "examples": ["EN", "DE", "ES", "FR"]
        },
        "saprouter": {
          "type": "string",
          "description": "SAP Router connection string",
          "examples": ["/H/saprouter.example.com/S/3299/H/"]
        },
        "trace": {
          "type": "boolean",
          "default": false,
          "description": "Enable SAP RFC tracing for debugging"
        }
      }
    },
    "odoo_connection": {
      "type": "object",
      "required": ["url", "database", "username", "password"],
      "properties": {
        "url": {
          "type": "string",
          "format": "uri",
          "description": "Odoo server URL",
          "examples": ["https://mycompany.odoo.com", "http://localhost:8069"]
        },
        "database": {
          "type": "string",
          "description": "Odoo database name",
          "minLength": 1,
          "maxLength": 128
        },
        "username": {
          "type": "string",
          "description": "Odoo username or email",
          "minLength": 1
        },
        "password": {
          "type": "string",
          "description": "Odoo password or API key",
          "minLength": 1
        },
        "port": {
          "type": "integer",
          "default": 8069,
          "minimum": 1,
          "maximum": 65535,
          "description": "Odoo server port"
        },
        "protocol": {
          "type": "string",
          "enum": ["jsonrpc", "jsonrpc+ssl"],
          "default": "jsonrpc+ssl",
          "description": "Connection protocol"
        }
      }
    },
    "generic_connection": {
      "type": "object",
      "description": "Generic connection parameters for custom adapters",
      "required": ["endpoint"],
      "properties": {
        "endpoint": {
          "type": "string",
          "format": "uri",
          "description": "ERP API endpoint URL"
        },
        "authentication": {
          "type": "object",
          "description": "Authentication configuration",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["basic", "bearer", "api_key", "oauth2"],
              "description": "Authentication method"
            },
            "credentials": {
              "type": "object",
              "description": "Credentials object (structure depends on type)"
            }
          }
        },
        "headers": {
          "type": "object",
          "description": "Additional HTTP headers",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "retry_policy": {
      "type": "object",
      "description": "Retry policy configuration for failed sync operations",
      "properties": {
        "max_attempts": {
          "type": "integer",
          "default": 5,
          "minimum": 1,
          "maximum": 10,
          "description": "Maximum number of retry attempts before moving to dead letter queue"
        },
        "backoff_strategy": {
          "type": "string",
          "enum": ["fixed", "exponential", "linear", "custom"],
          "default": "exponential",
          "description": "Backoff strategy for retries"
        },
        "backoff_seconds": {
          "type": "array",
          "description": "Backoff delay schedule in seconds (one per attempt). Required if strategy is 'custom'",
          "items": {
            "type": "integer",
            "minimum": 0
          },
          "minItems": 1,
          "maxItems": 10,
          "default": [30, 120, 600, 1800, 3600],
          "examples": [[30, 120, 600, 1800, 3600], [60, 300, 900]]
        },
        "exponential_base": {
          "type": "number",
          "default": 2.0,
          "minimum": 1.0,
          "description": "Base for exponential backoff (delay = base^attempt * initial_delay)"
        },
        "initial_delay_seconds": {
          "type": "integer",
          "default": 30,
          "minimum": 1,
          "description": "Initial delay for exponential/linear backoff strategies"
        },
        "max_delay_seconds": {
          "type": "integer",
          "default": 3600,
          "minimum": 1,
          "description": "Maximum delay cap for exponential backoff"
        },
        "jitter": {
          "type": "boolean",
          "default": true,
          "description": "Add random jitter to backoff delays to prevent thundering herd"
        },
        "jitter_factor": {
          "type": "number",
          "default": 0.1,
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Jitter randomization factor (0.0 = no jitter, 1.0 = up to 100% variation)"
        }
      }
    },
    "timeout_settings": {
      "type": "object",
      "description": "Timeout configuration for ERP operations",
      "properties": {
        "connection_timeout_seconds": {
          "type": "integer",
          "default": 30,
          "minimum": 1,
          "maximum": 300,
          "description": "Timeout for establishing connection to ERP"
        },
        "request_timeout_seconds": {
          "type": "integer",
          "default": 120,
          "minimum": 1,
          "maximum": 600,
          "description": "Timeout for individual API requests"
        },
        "sync_timeout_seconds": {
          "type": "integer",
          "default": 300,
          "minimum": 1,
          "maximum": 1800,
          "description": "Timeout for complete sync operation (including retries)"
        },
        "idle_timeout_seconds": {
          "type": "integer",
          "default": 60,
          "minimum": 1,
          "description": "Idle connection timeout"
        }
      }
    },
    "monitoring_config": {
      "type": "object",
      "description": "Monitoring and observability configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable monitoring metrics collection"
        },
        "metrics_interval_seconds": {
          "type": "integer",
          "default": 60,
          "minimum": 10,
          "description": "Interval for metrics aggregation"
        },
        "alert_on_dead_letter": {
          "type": "boolean",
          "default": true,
          "description": "Send alerts when items move to dead letter queue"
        },
        "alert_on_backlog_threshold": {
          "type": "integer",
          "default": 100,
          "minimum": 0,
          "description": "Alert when pending queue size exceeds this threshold (0=disabled)"
        },
        "alert_on_failure_rate": {
          "type": "number",
          "default": 0.2,
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Alert when failure rate exceeds this percentage (0.2 = 20%)"
        },
        "log_level": {
          "type": "string",
          "enum": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
          "default": "INFO",
          "description": "Logging level for ERP integration"
        },
        "log_payloads": {
          "type": "boolean",
          "default": false,
          "description": "Include full payloads in logs (may contain sensitive data)"
        }
      }
    },
    "feature_flags": {
      "type": "object",
      "description": "Feature flags for controlling ERP integration behavior",
      "properties": {
        "enable_batch_sync": {
          "type": "boolean",
          "default": false,
          "description": "Enable batching of multiple sync operations"
        },
        "batch_size": {
          "type": "integer",
          "default": 10,
          "minimum": 1,
          "maximum": 100,
          "description": "Number of items to batch together"
        },
        "enable_circuit_breaker": {
          "type": "boolean",
          "default": true,
          "description": "Enable circuit breaker to stop sending requests on repeated failures"
        },
        "circuit_breaker_threshold": {
          "type": "integer",
          "default": 5,
          "minimum": 1,
          "description": "Number of consecutive failures before opening circuit"
        },
        "circuit_breaker_timeout_seconds": {
          "type": "integer",
          "default": 300,
          "minimum": 10,
          "description": "Time to wait before attempting to close circuit"
        },
        "enable_idempotency_check": {
          "type": "boolean",
          "default": true,
          "description": "Check idempotency keys before processing"
        },
        "enable_payload_validation": {
          "type": "boolean",
          "default": true,
          "description": "Validate payloads against schema before sending to ERP"
        }
      }
    }
  },
  "examples": [
    {
      "adapter_type": "sap",
      "connection": {
        "ashost": "sap.example.com",
        "sysnr": "00",
        "client": "800",
        "user": "PSRA_USER",
        "passwd": "${SAP_PASSWORD}",
        "lang": "EN"
      },
      "retry_policy": {
        "max_attempts": 5,
        "backoff_strategy": "custom",
        "backoff_seconds": [30, 120, 600, 1800, 3600],
        "jitter": true
      },
      "timeout_settings": {
        "connection_timeout_seconds": 30,
        "request_timeout_seconds": 120,
        "sync_timeout_seconds": 300
      },
      "monitoring": {
        "enabled": true,
        "alert_on_dead_letter": true,
        "alert_on_backlog_threshold": 100,
        "log_level": "INFO"
      },
      "features": {
        "enable_circuit_breaker": true,
        "circuit_breaker_threshold": 5,
        "enable_idempotency_check": true
      }
    },
    {
      "adapter_type": "odoo",
      "connection": {
        "url": "https://mycompany.odoo.com",
        "database": "production",
        "username": "psra_integration",
        "password": "${ODOO_API_KEY}",
        "port": 8069,
        "protocol": "jsonrpc+ssl"
      },
      "retry_policy": {
        "max_attempts": 5,
        "backoff_strategy": "exponential",
        "initial_delay_seconds": 30,
        "exponential_base": 2.0,
        "max_delay_seconds": 3600
      },
      "timeout_settings": {
        "connection_timeout_seconds": 20,
        "request_timeout_seconds": 90,
        "sync_timeout_seconds": 180
      },
      "monitoring": {
        "enabled": true,
        "metrics_interval_seconds": 60,
        "alert_on_failure_rate": 0.15,
        "log_level": "INFO"
      },
      "features": {
        "enable_batch_sync": true,
        "batch_size": 20,
        "enable_circuit_breaker": true
      }
    }
  ]
}
